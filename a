  File "/home/worker/.local/lib/python3.11/site-packages/asyncpg/connection.py", line 1673, in _cancel_current_command

    self._cancellations.add(self._loop.create_task(self._cancel(waiter)))

                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

  File "/usr/local/lib/python3.11/asyncio/base_events.py", line 435, in create_task

    self._check_closed()

  File "/usr/local/lib/python3.11/asyncio/base_events.py", line 520, in _check_closed

    raise RuntimeError('Event loop is closed')

RuntimeError: Event loop is closed

[2025-09-29 06:16:54,978: ERROR/MainProcess] src.core.scheduler.tasks.cleanup_old_jobs_task[8cd47688-8f9e-4546-a493-422d55311c71]: Job cleanup failed: Task <Task pending name='Task-643' coro=<_async_cleanup_old_jobs_task() running at /app/src/core/scheduler/tasks.py:730> cb=[_release_waiter(<Future pendi...ask_wakeup()]>)() at /usr/local/lib/python3.11/asyncio/tasks.py:431]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

[2025-09-29 06:16:54,978: INFO/MainProcess] src.core.scheduler.tasks.cleanup_old_jobs_task[8cd47688-8f9e-4546-a493-422d55311c71]: Retrying cleanup task in 240 seconds

[2025-09-29 06:16:55,034: ERROR/MainProcess] {"correlation_id": "unknown", "error": "Retry in 240s", "error_type": "Retry", "event": "Async execution failed", "logger": "src.shared.async_utils", "level": "error", "timestamp": "2025-09-29T06:16:55.015481Z", "exception": "Traceback (most recent call last):\n  File \"/app/src/core/scheduler/tasks.py\", line 730, in _async_cleanup_old_jobs_task\n    cleanup_result = await session.execute(cleanup_query)\n                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/worker/.local/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/session.py\", line 463, in execute\n    result = await greenlet_spawn(\n             ^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/worker/.local/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 201, in greenlet_spawn\n    result = context.throw(*sys.exc_info())\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/worker/.local/lib/python3.11/site-packages/sqlalchemy/orm/session.py\", line 2365, in execute\n    return self._execute_internal(\n           ^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/worker/.local/lib/python3.11/site-packages/sqlalchemy/orm/session.py\", line 2241, in _execute_internal\n    conn = self._connection_for_bind(bind)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/worker/.local/lib/python3.11/site-packages/sqlalchemy/orm/session.py\", line 2110, in _connection_for_bind\n    return trans._connection_for_bind(engine, execution_options)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"<string>\", line 2, in _connection_for_bind\n  File \"/home/worker/.local/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py\", line 137, in _go\n    ret_value = fn(self, *arg, **kw)\n                ^^^^^^^^^^^^^^^^^^^^\n  File \"/home/worker/.local/lib/python3.11/site-packages/sqlalchemy/orm/session.py\", line 1189, in _connection_for_bind\n    conn = bind.connect()\n           ^^^^^^^^^^^^^^\n  File \"/home/worker/.local/lib/python3.11/site-packages/sqlalchemy/engine/base.py\", line 3277, in connect\n    return self._connection_cls(self)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/worker/.local/lib/python3.11/site-packages/sqlalchemy/engine/base.py\", line 143, in __init__\n    self._dbapi_connection = engine.raw_connection()\n                             ^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/worker/.local/lib/python3.11/site-packages/sqlalchemy/engine/base.py\", line 3301, in raw_connection\n    return self.pool.connect()\n           ^^^^^^^^^^^^^^^^^^^\n  File \"/home/worker/.local/lib/python3.11/site-packages/sqlalchemy/pool/base.py\", line 447, in connect\n    return _ConnectionFairy._checkout(self)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/worker/.local/lib/python3.11/site-packages/sqlalchemy/pool/base.py\", line 1363, in _checkout\n    with util.safe_reraise():\n  File \"/home/worker/.local/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py\", line 224, in __exit__\n    raise exc_value.with_traceback(exc_tb)\n  File \"/home/worker/.local/lib/python3.11/site-packages/sqlalchemy/pool/base.py\", line 1301, in _checkout\n    result = pool._dialect._do_ping_w_event(\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/worker/.local/lib/python3.11/site-packages/sqlalchemy/engine/default.py\", line 728, in _do_ping_w_event\n    return self.do_ping(dbapi_connection)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/worker/.local/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py\", line 1169, in do_ping\n    dbapi_connection.ping()\n  File \"/home/worker/.local/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py\", line 813, in ping\n    self._handle_exception(error)\n  File \"/home/worker/.local/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py\", line 794, in _handle_exception\n    raise error\n  File \"/home/worker/.local/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py\", line 811, in ping\n    _ = self.await_(self._async_ping())\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/worker/.local/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/worker/.local/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/worker/.local/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py\", line 820, in _async_ping\n    await tr.start()\n  File \"/home/worker/.local/lib/python3.11/site-packages/asyncpg/transaction.py\", line 146, in start\n    await self._connection.execute(query)\n  File \"/home/worker/.local/lib/python3.11/site-packages/asyncpg/connection.py\", line 349, in execute\n    result = await self._protocol.query(query, timeout)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"asyncpg/protocol/protocol.pyx\", line 375, in query\nRuntimeError: Task <Task pending name='Task-643' coro=<_async_cleanup_old_jobs_task() running at /app/src/core/scheduler/tasks.py:730> cb=[_release_waiter(<Future pendi...ask_wakeup()]>)() at /usr/local/lib/python3.11/asyncio/tasks.py:431]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/app/src/shared/async_utils.py\", line 160, in safe_async_run\n    return _run_async_new_loop(coro, timeout)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/src/shared/async_utils.py\", line 199, in _run_async_new_loop\n    return asyncio.run(_with_timeout())\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/usr/local/lib/python3.11/asyncio/runners.py\", line 190, in run\n    return runner.run(main)\n           ^^^^^^^^^^^^^^^^\n  File \"/usr/local/lib/python3.11/asyncio/runners.py\", line 118, in run\n    return self._loop.run_until_complete(task)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/usr/local/lib/python3.11/asyncio/base_events.py\", line 654, in run_until_complete\n    return future.result()\n           ^^^^^^^^^^^^^^^\n  File \"/app/src/shared/async_utils.py\", line 198, in _with_timeout\n    return await asyncio.wait_for(coro, timeout=timeout)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/usr/local/lib/python3.11/asyncio/tasks.py\", line 489, in wait_for\n    return fut.result()\n           ^^^^^^^^^^^^\n  File \"/app/src/core/scheduler/tasks.py\", line 780, in _async_cleanup_old_jobs_task\n    raise task_instance.retry(countdown=countdown)\n          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/worker/.local/lib/python3.11/site-packages/celery/app/task.py\", line 764, in retry\n    raise ret\ncelery.exceptions.Retry: Retry in 240s"}

[2025-09-29 06:16:55,034: WARNING/MainProcess] {"correlation_id": "unknown", "fallback_result": {"status": "failed", "error": "Cleanup task execution failed", "correlation_id": "cleanup_8cd47688-8f9e-4546-a493-422d55311c71"}, "event": "Using fallback result due to execution failure", "logger": "src.shared.async_utils", "level": "warning", "timestamp": "2025-09-29T06:16:55.034822Z"}

[2025-09-29 06:16:55,036: INFO/MainProcess] Task src.core.scheduler.tasks.cleanup_old_jobs_task[8cd47688-8f9e-4546-a493-422d55311c71] succeeded in 0.16415799299988976s: {'status': 'failed', 'error': 'Cleanup task execution failed', 'correlation_id': 'cleanup_8cd47688-8f9e-4546-a493-422d55311c71'}

[2025-09-29 06:16:55,611: INFO/MainProcess] Task src.core.scheduler.tasks.cleanup_old_jobs_task[8cd47688-8f9e-4546-a493-422d55311c71] received

[2025-09-29 06:16:55,617: DEBUG/MainProcess] basic.qos: prefetch_count->2

[2025-09-29 06:17:06,997: DEBUG/MainProcess] pidbox received method ping() [reply_to:{'exchange': 'reply.celery.pidbox', 'routing_key': '8c68116d-86d2-34ec-8d5a-b1d36040b4ce'} ticket:77f93e7e-2585-468c-866b-9758e3894a45]

[2025-09-29 06:17:31,089: INFO/MainProcess] Task src.core.scheduler.tasks.monitor_job_health_task[123c731e-913a-4086-8657-d88484805836] received

[2025-09-29 06:17:31,099: DEBUG/MainProcess] TaskPool: Apply <function fast_trace_task at 0x7ace68f8f100> (args:('src.core.scheduler.tasks.monitor_job_health_task', '123c731e-913a-4086-8657-d88484805836', {'lang': 'py', 'task': 'src.core.scheduler.tasks.monitor_job_health_task', 'id': '123c731e-913a-4086-8657-d88484805836', 'shadow': None, 'eta': None, 'expires': None, 'group': None, 'group_index': None, 'retries': 0, 'timelimit': [None, None], 'root_id': '123c731e-913a-4086-8657-d88484805836', 'parent_id': None, 'argsrepr': '()', 'kwargsrepr': '{}', 'origin': 'gen1@8e485819ccec', 'ignore_result': False, 'replaced_task_nesting': 0, 'stamped_headers': None, 'stamps': {}, 'properties': {'correlation_id': '123c731e-913a-4086-8657-d88484805836', 'reply_to': 'ed1312f6-b20b-3101-ac13-633e09f0ef54', 'delivery_mode': 2, 'delivery_info': {'exchange': '', 'routing_key': 'maintenance_queue'}, 'priority': 0, 'body_encoding': 'base64', 'delivery_tag': 'a16cdce7-3992-4cff-bdc6-74850995515d'}, 'reply_to': 'ed1312f6-b20b-3101-ac13-633e09f0ef54', 'correlation_id': '123c731e-913a-4086-8657-d88484805836', 'hostname':... kwargs:{})

[2025-09-29 06:17:31,106: INFO/MainProcess] src.core.scheduler.tasks.monitor_job_health_task[123c731e-913a-4086-8657-d88484805836]: Starting job health monitoring

[2025-09-29 06:17:31,107: INFO/MainProcess] {"correlation_id": "unknown", "has_running_loop": false, "thread_id": 135026873444032, "event": "Starting safe async execution", "logger": "src.shared.async_utils", "level": "info", "timestamp": "2025-09-29T06:17:31.107540Z"}

[2025-09-29 06:17:31,107: DEBUG/MainProcess] {"correlation_id": "unknown", "event": "No event loop detected, creating new one", "logger": "src.shared.async_utils", "level": "debug", "timestamp": "2025-09-29T06:17:31.107752Z"}

[2025-09-29 06:17:31,108: DEBUG/MainProcess] Using selector: EpollSelector

[2025-09-29 06:17:31,125: WARNING/MainProcess] <frozen _collections_abc>:774: RuntimeWarning: coroutine 'Connection._cancel' was never awaited


[2025-09-29 06:17:31,284: INFO/MainProcess] src.core.scheduler.tasks.monitor_job_health_task[123c731e-913a-4086-8657-d88484805836]: Job system healthy

[2025-09-29 06:17:31,287: INFO/MainProcess] Task src.core.scheduler.tasks.monitor_job_health_task[123c731e-913a-4086-8657-d88484805836] succeeded in 0.18368981199978407s: {'status': 'completed', 'health_status': 'healthy', 'health_issues': [], 'active_jobs': 8, 'running_jobs': 0, 'stuck_jobs': 0, 'success_rate_24h': 1.0, 'jobs_completed_24h': 1, 'jobs_failed_24h': 0, 'correlation_id': 'health_123c731e-913a-4086-8657-d88484805836'}