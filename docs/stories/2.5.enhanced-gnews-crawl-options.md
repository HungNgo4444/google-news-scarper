# Story 2.5: Enhanced GNEWS Crawl Options (Topic, Location, Site Search)

## Status
Draft

## Story

**As a** System Administrator/Content Manager,
**I want** multiple search modes for category crawling (topic-based, location-based, website-based) beyond just keywords,
**so that** I can discover news content more flexibly using predefined topics, specific locations, or monitored websites without complex keyword configuration.

## Context

**Current Limitation**: Categories only support keyword-based search with OR logic. Users must manually craft keyword lists to capture topic areas, locations, or specific news sources.

**Enhancement Opportunity**: GNEWS library (newspaper4k) provides 4 additional search capabilities that are currently unused:

1. **Topic-Based Search**: 8 predefined topics (WORLD, NATION, BUSINESS, TECHNOLOGY, ENTERTAINMENT, SPORTS, SCIENCE, HEALTH)
2. **Location-Based Search**: Search news from specific cities/locations (e.g., "Ha Noi", "New York")
3. **Site-Based Search**: Monitor specific news websites (e.g., "vnexpress.net", "bbc.com")
4. **Exclude Websites Filter**: Block spam/unreliable domains from any search mode
5. **Top News Integration**: Include trending/top news alongside other search methods

**User Benefit**: Simplifies category configuration for common use cases:
- Topic browsing without keyword brainstorming
- Regional news coverage by location
- Source-specific monitoring
- Better content filtering via domain exclusions

## Acceptance Criteria

1. **Database Schema Enhancement**: Category model MUST include new fields:
   - `search_mode` (String): "keyword" | "topic" | "location" | "site" | "mixed"
   - `topic` (String, optional): One of 8 GNEWS topics
   - `location` (String, optional): City/location name
   - `site` (String, optional): Website domain
   - `exclude_websites` (JSON array): List of domains to filter out
   - `enable_top_news` (Boolean): Include trending news flag

2. **API Schema Validation**: Category create/update requests MUST validate:
   - `search_mode` is required and one of valid values
   - If `search_mode = "topic"`, `topic` field is required and must be valid GNEWS topic
   - If `search_mode = "location"`, `location` field is required
   - If `search_mode = "site"`, `site` field is required and valid domain format
   - If `search_mode = "keyword"`, `keywords` array is required (existing behavior)
   - `exclude_websites` domains follow valid format if provided

3. **Crawler Engine Support**: SyncCrawlerEngine MUST implement:
   - `search_by_topic(topic)` method using `gnews.get_news_by_topic()`
   - `search_by_location(location)` method using `gnews.get_news_by_location()`
   - `search_by_site(site)` method using `gnews.get_news_by_site()`
   - Apply `exclude_websites` filter to all search results
   - Mixed mode combining multiple search methods

4. **Frontend UI - Search Mode Selection**: CategoryForm MUST show:
   - "Search Mode" dropdown with 5 options (keyword/topic/location/site/mixed)
   - Conditional field rendering based on selected mode
   - Clear field labels and help text for each mode

5. **Frontend UI - Conditional Fields**: Based on search_mode:
   - **Keyword mode**: Show existing keywords + exclude_keywords inputs
   - **Topic mode**: Show topic dropdown with 8 GNEWS options
   - **Location mode**: Show location text input with examples
   - **Site mode**: Show site input with domain format hint
   - **Mixed mode**: Show all fields above
   - **All modes**: Show exclude_websites multi-input and enable_top_news checkbox

6. **Category Display Enhancement**: Category list MUST show:
   - Search mode indicator badge
   - Primary search value (keywords preview, topic name, location, or site)
   - Exclude websites count if any

7. **Backward Compatibility**: Existing keyword-based categories MUST:
   - Auto-default to `search_mode = "keyword"` on first load
   - Continue working without requiring migration or re-configuration

## Tasks / Subtasks

- [ ] **Phase 1: Database Migration** (AC: 1) - 45 minutes
  - [ ] Create migration file `012_add_enhanced_crawl_options.py`
  - [ ] Add `search_mode` column (VARCHAR(20), default 'keyword', NOT NULL)
  - [ ] Add `topic` column (VARCHAR(50), nullable)
  - [ ] Add `location` column (VARCHAR(100), nullable)
  - [ ] Add `site` column (VARCHAR(255), nullable)
  - [ ] Add `exclude_websites` column (JSONB, default '[]')
  - [ ] Add `enable_top_news` column (BOOLEAN, default FALSE)
  - [ ] Add CHECK constraint for search_mode valid values
  - [ ] Add CHECK constraint for topic valid values if not NULL
  - [ ] Create index on search_mode column
  - [ ] Run migration and verify schema changes

- [ ] **Phase 2: Backend - Database Model** (AC: 1) - 30 minutes
  - [ ] Update `src/database/models/category.py`:
    - [ ] Add `search_mode` mapped column with default 'keyword'
    - [ ] Add `topic` mapped column (Optional[str])
    - [ ] Add `location` mapped column (Optional[str])
    - [ ] Add `site` mapped column (Optional[str])
    - [ ] Add `exclude_websites` mapped column (JSONB, default list)
    - [ ] Add `enable_top_news` mapped column (Boolean, default False)
    - [ ] Add table constraints for validation
  - [ ] Create GNEWS constants file `src/core/crawler/gnews_constants.py`:
    - [ ] Define VALID_TOPICS list from gnews.utils.constants
    - [ ] Define VALID_SEARCH_MODES enum
    - [ ] Export for reuse in schemas and crawler

- [ ] **Phase 3: Backend - API Schemas** (AC: 2) - 1 hour
  - [ ] Update `src/api/schemas/category.py`:
    - [ ] Add fields to `CreateCategoryRequest`:
      - [ ] `search_mode` with default 'keyword'
      - [ ] `topic` (Optional[str])
      - [ ] `location` (Optional[str])
      - [ ] `site` (Optional[str])
      - [ ] `exclude_websites` (Optional[List[str]])
      - [ ] `enable_top_news` (bool, default False)
    - [ ] Add fields to `UpdateCategoryRequest` (all optional)
    - [ ] Add fields to `CategoryResponse`
    - [ ] Create `@validator` for `search_mode`:
      - [ ] Must be one of VALID_SEARCH_MODES
    - [ ] Create `@validator` for `topic`:
      - [ ] If search_mode='topic', topic is required
      - [ ] Topic must be in VALID_TOPICS list
    - [ ] Create `@validator` for `location`:
      - [ ] If search_mode='location', location is required
      - [ ] Location min length validation
    - [ ] Create `@validator` for `site`:
      - [ ] If search_mode='site', site is required
      - [ ] Validate domain format (regex pattern)
    - [ ] Create `@validator` for `exclude_websites`:
      - [ ] Validate each domain format
      - [ ] Max 20 domains limit
    - [ ] Add cross-field validation:
      - [ ] If mode='keyword', keywords must not be empty
      - [ ] If mode='mixed', at least 2 search criteria required

- [ ] **Phase 4: Backend - Crawler Engine** (AC: 3) - 3 hours
  - [ ] Update `src/core/crawler/sync_engine.py`:
    - [ ] Add `search_by_topic()` method:
      - [ ] Import gnews and call `get_news_by_topic(topic)`
      - [ ] Handle rate limiting and errors
      - [ ] Return resolved article URLs
    - [ ] Add `search_by_location()` method:
      - [ ] Call `get_news_by_location(location)`
      - [ ] URL resolution and error handling
    - [ ] Add `search_by_site()` method:
      - [ ] Call `get_news_by_site(site)`
      - [ ] Handle site-specific edge cases
    - [ ] Add `_apply_exclude_websites_filter()` method:
      - [ ] Filter URLs by domain exclusion list
      - [ ] Use urlparse for reliable domain extraction
    - [ ] Update `search_google_news()` method:
      - [ ] Add search_mode parameter
      - [ ] Route to appropriate search method based on mode
      - [ ] Support `enable_top_news` flag to include `get_top_news()`
    - [ ] Add `search_mixed_mode()` method:
      - [ ] Combine results from multiple search methods
      - [ ] Deduplicate URLs across sources
      - [ ] Apply exclude_websites filter to combined results
    - [ ] Update `crawl_category_sync()`:
      - [ ] Read category.search_mode and route appropriately
      - [ ] Pass exclude_websites to search methods
      - [ ] Handle enable_top_news flag
  - [ ] Add unit tests for new search methods:
    - [ ] Test topic-based search with all 8 topics
    - [ ] Test location-based search with various cities
    - [ ] Test site-based search with different domains
    - [ ] Test exclude_websites filtering
    - [ ] Test mixed mode deduplication

- [ ] **Phase 5: Frontend - TypeScript Types** (AC: 4) - 20 minutes
  - [ ] Update `frontend/src/types/shared.ts`:
    - [ ] Add `SearchMode` type: "keyword" | "topic" | "location" | "site" | "mixed"
    - [ ] Add `GNewsTopic` type with 8 valid topics
    - [ ] Add new fields to `Category` interface:
      - [ ] `search_mode: SearchMode`
      - [ ] `topic?: GNewsTopic`
      - [ ] `location?: string`
      - [ ] `site?: string`
      - [ ] `exclude_websites?: string[]`
      - [ ] `enable_top_news?: boolean`
    - [ ] Add to `CreateCategoryRequest` and `UpdateCategoryRequest`

- [ ] **Phase 6: Frontend - CategoryForm Enhancement** (AC: 4, 5) - 2.5 hours
  - [ ] Update `frontend/src/components/features/categories/CategoryForm.tsx`:
    - [ ] Add search_mode state with default 'keyword'
    - [ ] Add topic, location, site, exclude_websites, enable_top_news state
    - [ ] Add "Search Mode" dropdown:
      - [ ] Options: Keyword | Topic | Location | Website | Mixed
      - [ ] onChange handler to update search_mode state
      - [ ] Clear conditional fields when mode changes
    - [ ] Implement conditional field rendering:
      - [ ] If mode='keyword': Show keywords + exclude_keywords inputs (existing)
      - [ ] If mode='topic': Show topic dropdown with 8 options
      - [ ] If mode='location': Show location text input with placeholder examples
      - [ ] If mode='site': Show site input with domain format hint
      - [ ] If mode='mixed': Show all fields above
    - [ ] Add "Exclude Websites" multi-input (all modes):
      - [ ] Comma-separated input with tag display
      - [ ] Parse domains and validate format
      - [ ] Show current count
    - [ ] Add "Include Top News" checkbox (all modes)
    - [ ] Update form validation:
      - [ ] Validate required fields based on search_mode
      - [ ] Validate topic is valid GNEWS topic
      - [ ] Validate site domain format
      - [ ] Validate exclude_websites domains
    - [ ] Update handleSubmit to include new fields
  - [ ] Add help text and examples for each field:
    - [ ] Topic: "Browse news by predefined categories"
    - [ ] Location: "e.g., Ha Noi, New York, Tokyo, London"
    - [ ] Site: "e.g., vnexpress.net, bbc.com, cnn.com"
    - [ ] Exclude Websites: "Filter out unwanted domains"

- [ ] **Phase 7: Frontend - Category Display** (AC: 6) - 1 hour
  - [ ] Update `frontend/src/components/features/categories/CategoriesList.tsx`:
    - [ ] Add search mode indicator badge:
      - [ ] Different colors per mode (keyword=blue, topic=purple, location=green, site=orange, mixed=gray)
      - [ ] Show mode icon (🔑/📂/📍/🌐/🎛️)
    - [ ] Add search value display:
      - [ ] Keyword mode: Show first 2 keywords + count
      - [ ] Topic mode: Show topic name
      - [ ] Location mode: Show location
      - [ ] Site mode: Show site domain
      - [ ] Mixed mode: Show "Multiple sources"
    - [ ] Add exclude websites indicator:
      - [ ] Show count if > 0: "🚫 3 sites excluded"
    - [ ] Update category detail modal/tooltip:
      - [ ] Show full search configuration
      - [ ] List all exclude_websites if any
      - [ ] Show enable_top_news status

- [ ] **Phase 8: Data Migration for Existing Categories** (AC: 7) - 30 minutes
  - [ ] Create data migration script `scripts/backfill_search_mode.py`:
    - [ ] Set `search_mode = 'keyword'` for all existing categories
    - [ ] Ensure backward compatibility
    - [ ] Log migration results
  - [ ] Run migration on existing data
  - [ ] Verify all categories load correctly in UI

- [ ] **Phase 9: Integration Testing** (AC: All) - 1.5 hours
  - [ ] Test end-to-end workflows:
    - [ ] Create category with topic search → Trigger crawl → Verify articles
    - [ ] Create category with location search → Verify results
    - [ ] Create category with site search → Verify source filtering
    - [ ] Create category with exclude_websites → Verify domain filtering
    - [ ] Create mixed mode category → Verify combined results
    - [ ] Enable top_news → Verify trending articles included
  - [ ] Test validation errors:
    - [ ] Missing required fields for each mode
    - [ ] Invalid topic selection
    - [ ] Invalid site domain format
    - [ ] Invalid exclude_websites format
  - [ ] Test backward compatibility:
    - [ ] Existing keyword categories work unchanged
    - [ ] Edit existing category and change search mode
  - [ ] Test UI responsiveness:
    - [ ] Search mode dropdown interaction
    - [ ] Conditional fields show/hide correctly
    - [ ] Form validation messages display properly

## Dev Notes

### GNEWS Library Capabilities
[Source: newspaper4k-master/newspaper/google_news.py:40-190, stubs/gnews/gnews.pyi:17-69]

The project uses **GNEWS library** (via newspaper4k) which provides 5 search methods currently underutilized:

**Available Search Methods**:
1. `get_news(keyword)` - Current implementation (keyword search)
2. `get_news_by_topic(topic)` - **NEW**: Predefined topic search
3. `get_news_by_location(location)` - **NEW**: Location-based search
4. `get_news_by_site(site)` - **NEW**: Website-specific search
5. `get_top_news()` - **NEW**: Trending news (can combine with others)

**Valid GNEWS Topics** (8 predefined):
```python
TOPICS = ['WORLD', 'NATION', 'BUSINESS', 'TECHNOLOGY', 'ENTERTAINMENT', 'SPORTS', 'SCIENCE', 'HEALTH']
```
[Source: newspaper4k-master/stubs/gnews/utils/constants.pyi:10]

**GNEWS Constructor Parameters**:
```python
gnews.GNews(
    language="vi",
    country="VN",
    max_results=100,
    period="7d",  # or start_date/end_date
    exclude_websites=['spam.com', 'ads.com']  # NEW: Domain filtering
)
```
[Source: newspaper4k-master/stubs/gnews/gnews.pyi:20-30]

### Current Category Model
[Source: src/database/models/category.py:9-165]

**Existing Fields**:
- `name`: String(255), unique, indexed
- `keywords`: JSONB array, not empty constraint
- `exclude_keywords`: JSONB array, default empty
- `is_active`: Boolean, default True
- `language`: String(5), default "vi"
- `country`: String(5), default "VN"
- `crawl_period`: String(10), nullable

**New Fields to Add**:
- `search_mode`: String(20), default "keyword", CHECK constraint
- `topic`: String(50), nullable, CHECK for valid topics
- `location`: String(100), nullable
- `site`: String(255), nullable
- `exclude_websites`: JSONB array, default empty
- `enable_top_news`: Boolean, default False

### Current Crawler Implementation
[Source: src/core/crawler/sync_engine.py:855-1005]

**Current Flow**:
1. `search_google_news()` - Uses keyword OR logic, gnews.get_news()
2. `resolve_google_news_urls()` - Playwright URL resolution (1 browser + 10 tabs)
3. `extract_articles_with_threading()` - newspaper4k extraction (5 threads)
4. `crawl_category_sync()` - Orchestration method

**Enhancement Points**:
- Add topic/location/site search methods alongside keyword search
- Implement exclude_websites filtering after URL resolution
- Support mixed mode by combining multiple search sources
- Add top_news integration as optional enhancement

### API Schema Patterns
[Source: src/api/schemas/category.py:49-176]

**Current Validation Pattern**:
```python
class CreateCategoryRequest(BaseModel):
    name: str = Field(..., min_length=1, max_length=255)
    keywords: List[str] = Field(..., min_items=1, max_items=20)

    @validator('keywords')
    def validate_keywords(cls, v):
        cleaned = [kw.strip() for kw in v if kw.strip()]
        if not cleaned:
            raise ValueError('At least one valid keyword is required')
        return cleaned
```

**New Validator Pattern to Add**:
```python
@validator('search_mode')
def validate_search_mode(cls, v):
    VALID_MODES = ['keyword', 'topic', 'location', 'site', 'mixed']
    if v not in VALID_MODES:
        raise ValueError(f'search_mode must be one of: {", ".join(VALID_MODES)}')
    return v

@validator('topic')
def validate_topic(cls, v, values):
    if values.get('search_mode') == 'topic' and not v:
        raise ValueError('topic is required when search_mode is "topic"')
    if v and v not in VALID_TOPICS:
        raise ValueError(f'topic must be one of: {", ".join(VALID_TOPICS)}')
    return v
```

### Frontend Form Patterns
[Source: frontend/src/components/features/categories/CategoryForm.tsx:21-69]

**Current Form State**:
```typescript
const [formData, setFormData] = useState({
  name: '',
  keywords: [] as string[],
  exclude_keywords: [] as string[],
  is_active: true,
  language: 'vi',
  country: 'VN'
});
```

**Enhanced Form State to Add**:
```typescript
const [formData, setFormData] = useState({
  // ... existing fields ...
  search_mode: 'keyword' as SearchMode,
  topic: null as GNewsTopic | null,
  location: '',
  site: '',
  exclude_websites: [] as string[],
  enable_top_news: false
});
```

**Conditional Rendering Pattern**:
```typescript
{formData.search_mode === 'topic' && (
  <div>
    <label>Topic *</label>
    <select value={formData.topic || ''} onChange={...}>
      <option value="">Select a topic</option>
      <option value="WORLD">World</option>
      <option value="NATION">Nation</option>
      {/* ... other topics ... */}
    </select>
  </div>
)}
```

### Testing Standards
[Source: docs/architecture/coding-standards.md:18-23, docs/architecture/testing-strategy.md]

**Backend Testing**:
- Location: `tests/unit/crawler/test_enhanced_search.py`
- Framework: pytest with FastAPI TestClient
- Must test all 5 search modes independently
- Must test validation errors for each mode
- Must test mixed mode deduplication logic

**Frontend Testing**:
- Location: `frontend/src/components/features/categories/CategoryForm.test.tsx`
- Framework: Vitest + React Testing Library
- Must test conditional field rendering for each search_mode
- Must test form validation for required fields per mode
- Must test search mode switching clears conditional fields

### Critical Implementation Notes

1. **Domain Validation Regex**:
```python
DOMAIN_REGEX = r'^(?:[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?\.)+[a-zA-Z]{2,}$'
```

2. **URL Domain Extraction**:
```python
from urllib.parse import urlparse

def extract_domain(url: str) -> str:
    parsed = urlparse(url)
    return parsed.netloc.replace('www.', '')
```

3. **Exclude Websites Filter**:
```python
def filter_excluded_domains(urls: List[str], exclude_websites: List[str]) -> List[str]:
    return [url for url in urls if extract_domain(url) not in exclude_websites]
```

4. **Mixed Mode Deduplication**:
```python
def search_mixed_mode(category):
    all_urls = []
    seen = set()

    if category.keywords:
        urls = search_by_keyword(category.keywords)
        all_urls.extend(u for u in urls if u not in seen)
        seen.update(urls)

    if category.topic:
        urls = search_by_topic(category.topic)
        all_urls.extend(u for u in urls if u not in seen)
        seen.update(urls)

    # ... similar for location, site ...

    if category.enable_top_news:
        urls = search_top_news()
        all_urls.extend(u for u in urls if u not in seen)

    return filter_excluded_domains(all_urls, category.exclude_websites)
```

### Source Tree Context
[Source: docs/architecture/source-tree.md]

**Files to Modify**:
- Backend:
  - `src/database/models/category.py` - Add new columns
  - `src/database/migrations/versions/012_*.py` - Migration file
  - `src/api/schemas/category.py` - Schema validation
  - `src/core/crawler/sync_engine.py` - Search methods
  - `src/core/crawler/gnews_constants.py` - New constants file
- Frontend:
  - `frontend/src/types/shared.ts` - Type definitions
  - `frontend/src/components/features/categories/CategoryForm.tsx` - Form UI
  - `frontend/src/components/features/categories/CategoriesList.tsx` - Display

**New Files to Create**:
- `src/core/crawler/gnews_constants.py` - GNEWS constants (topics, modes)
- `tests/unit/crawler/test_enhanced_search.py` - Backend tests
- `scripts/backfill_search_mode.py` - Data migration script

### Previous Story Context
[Source: Story 2.4 - Keywords Relevance Fix]

**Relevant Learnings**:
- Database migrations must check if table/column exists before creating
- Always use UTF-8 encoding for Vietnamese content
- Junction tables need proper CASCADE constraints
- Frontend must handle null/undefined values gracefully
- Validation errors need user-friendly messages

### Testing

**Backend Tests** (`tests/unit/crawler/test_enhanced_search.py`):
- Test `search_by_topic()` with all 8 valid topics
- Test `search_by_location()` with various city names
- Test `search_by_site()` with different domain formats
- Test `filter_excluded_domains()` with various URL formats
- Test `search_mixed_mode()` deduplication logic
- Test validation errors for invalid topics/domains
- Mock gnews library calls to avoid external dependencies

**Frontend Tests** (`frontend/src/components/features/categories/CategoryForm.test.tsx`):
- Test search mode dropdown renders all options
- Test conditional fields show/hide based on search_mode
- Test topic dropdown shows all 8 GNEWS topics
- Test location input validation
- Test site input domain format validation
- Test exclude_websites parsing and display
- Test form submission with different search modes
- Test validation error messages display

**Integration Tests**:
- Create category with each search mode → Verify in database
- Trigger crawl for each mode → Verify articles retrieved
- Test exclude_websites filter → Verify domains excluded
- Test mixed mode → Verify results from multiple sources
- Test backward compatibility with existing keyword categories

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-03 | 1.0 | Initial story creation | Claude (Scrum Master) |
