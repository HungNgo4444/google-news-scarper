# Story 1.3: Backend Category API Fix

## Status

Ready for Review

## Story

**As a** System Administrator,
**I want** the backend Category API to handle category creation without errors,
**so that** the frontend interface can successfully create and manage news categories for crawling.

## Acceptance Criteria

1. **Category Creation API Works Correctly**

   - POST /api/v1/categories endpoint processes requests without async context manager errors
   - Backend server starts without Pydantic Settings validation errors
   - API returns proper HTTP 201 status with created category data
2. **Settings Configuration Handles Environment Variables**

   - Settings class properly loads .env file variables without "Extra inputs not permitted" errors
   - Backend server initializes successfully with current environment configuration
   - Database connection initializes correctly through Settings
3. **Async Context Management Functions Properly**

   - Database session context managers work correctly throughout the repository layer
   - No "async_generator object does not support asynchronous context manager protocol" errors
   - All CRUD operations (Create, Read, Update, Delete) work correctly

## Tasks / Subtasks

- [x] **Fix Pydantic Settings Configuration** (AC: 2)

  - [x] Update Settings class in src/shared/config.py to allow extra environment variables
  - [x] Test settings loading with current .env file configuration
  - [x] Verify backend server starts without validation errors
- [x] **Fix Async Context Manager Issues** (AC: 3)

  - [x] Verify @asynccontextmanager decorator is properly applied to get_db_session()
  - [x] Fix any remaining async context issues in BaseRepository
  - [x] Test all repository CRUD operations work correctly
- [x] **Test Category API Endpoints** (AC: 1)

  - [x] Test POST /api/v1/categories with valid category data
  - [x] Test GET /api/v1/categories returns empty list initially
  - [x] Verify API error handling works properly
  - [x] Test frontend-backend integration with curl and actual frontend
- [x] **Validate System Integration** (AC: 1, 2, 3)

  - [x] Restart backend server and verify healthy startup
  - [x] Test complete category creation workflow end-to-end
  - [x] Verify frontend UI can successfully create categories
  - [x] Check Docker container health status

## Dev Notes

### Issue Analysis from Previous Investigation

Based on comprehensive analysis by BMad Master, the critical issues identified are:

1. **Pydantic Settings Validation Error**: Backend server fails to start due to "Extra inputs are not permitted" errors when loading .env file variables
2. **Async Context Manager Error**: Category creation fails with "'async_generator' object does not support the asynchronous context manager protocol" error

### Technical Context from Architecture

**Tech Stack Requirements**: [Source: architecture/tech-stack.md]

- Backend: Python 3.11 + FastAPI + PostgreSQL + Redis
- Environment Management: Pydantic Settings with .env file loading
- Database: PostgreSQL 15 with async SQLAlchemy and Alembic migrations

**Backend Architecture**: [Source: architecture/data-models.md#category-model]

- Category Model: UUID id, string name, string[] keywords/exclude_keywords, boolean is_active, datetime timestamps
- TypeScript Interface: Shared types in frontend/src/types/shared.ts

**Coding Standards**: [Source: architecture/coding-standards.md]

- Environment Variables: Access only through config objects (src/shared/config.py), never process.env directly
- Database Migrations: All schema changes must go through Alembic migrations
- Error Handling: All API routes must use standard error handler middleware

### File Locations Based on Project Structure

[Source: architecture/source-tree.md]

- Settings configuration: `src/shared/config.py`
- Database connection: `src/database/connection.py`
- Category repository: `src/database/repositories/category_repo.py`
- Base repository: `src/database/repositories/base.py`
- Category API routes: `src/api/routes/categories.py`
- Main FastAPI app: `src/api/main.py`

### Specific Technical Issues

**Settings Configuration Problem**:

- Current Settings class uses strict validation that rejects extra .env variables
- Need to modify model_config to allow extra fields or filter only needed variables

**Database Context Manager Problem**:

- get_db_session() function needs proper @asynccontextmanager decorator
- BaseRepository methods may have nested context manager issues
- Category creation workflow fails at database operation level

### Testing Requirements

**Testing Standards from Architecture**: [Source: architecture/tech-stack.md]

- **Backend Testing**: Use Pytest 7.x+ for API and service testing
- **Test File Locations**: Backend tests in `tests/` directory
- **Specific Requirements**:
  - Test Settings class loading with various .env configurations
  - Test category repository CRUD operations
  - Test API endpoint responses and error handling
  - Test database session management in async context
  - Verify end-to-end category creation workflow

## Change Log

| Date       | Version | Description                                         | Author           |
| ---------- | ------- | --------------------------------------------------- | ---------------- |
| 2025-09-13 | 1.0     | Initial story creation for backend API category fix | Scrum Master Bob |

## Dev Agent Record

*This section will be populated by the development agent during implementation*

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results

*Results from QA Agent review will be populated here after story completion*
