# Story 2.4: URGENT - Fix Keywords Matched & Relevance Score Bug

## Status
Ready for Review
## Story

**As a** System User,
**I want** articles to have accurate keyword matching and relevance scores with proper multi-category linking,
**so that** I can see which keywords matched each article, understand article relevance to categories, and find articles across all matching categories (not just the one it was crawled from).

## Context

**URGENT BUG:** Database analysis revealed critical issues affecting all 369 articles:
- ❌ **keywords_matched = {}** (empty array) for ALL articles
- ❌ **relevance_score = 1.0** (hardcoded) for ALL articles
- ❌ **ArticleCategory junction table missing** (model exists but table not created)
- ❌ **Multi-category linking NOT working** (articles only linked to crawl category)

**Root Causes Identified:**
1. Migration for `article_categories` table was never created (model exists in code but table doesn't exist in DB)
2. `sync_engine.py` (Line 1454-1461) bypasses keyword matcher & relevance scorer entirely
3. `sync_article_repo.py` (Line 91) hardcodes `relevance_score=1.0` instead of using calculated value
4. No auto-linking logic to match articles with multiple categories

## Acceptance Criteria

1. **Keywords Matched Populated:** After crawl, articles MUST have `keywords_matched` array containing actual keywords found in title/content (not empty)

2. **Relevance Score Calculated:** Articles MUST have `relevance_score` based on percentage of category keywords matched (not hardcoded 1.0)

3. **Junction Table Created:** `article_categories` table MUST exist in database with proper indexes and constraints

4. **Multi-Category Linking:** Articles MUST be automatically linked to ALL matching categories (not just crawl category) with individual relevance scores per category

5. **Frontend Display:** Job Articles Modal MUST show:
   - Multiple category badges (primary vs auto-linked)
   - Matched keywords list
   - Relevance score percentage per category

## Tasks / Subtasks

- [ ] **Phase 1: Database Migration** (AC: 3) - 30 minutes
  - [ ] Create migration file `src/database/migrations/versions/011_create_article_categories_table.py`
  - [ ] Check if table already exists (model may have created it), skip creation if exists
  - [ ] Create `article_categories` table with columns:
    - [ ] `id` (UUID, primary key, gen_random_uuid())
    - [ ] `article_id` (UUID, FK to articles.id, CASCADE delete)
    - [ ] `category_id` (UUID, FK to categories.id, CASCADE delete)
    - [ ] `relevance_score` (DECIMAL(3,2), default 1.0)
    - [ ] `created_at`, `updated_at` (timestamps)
  - [ ] Add unique constraint on (article_id, category_id)
  - [ ] Create indexes:
    - [ ] `idx_article_categories_article_id` on article_id
    - [ ] `idx_article_categories_category_id` on category_id
    - [ ] `idx_article_categories_composite` unique on (article_id, category_id)
    - [ ] `idx_article_categories_relevance` on relevance_score
  - [ ] Migrate existing data from articles → article_categories (via crawl_jobs):
    ```sql
    INSERT INTO article_categories (article_id, category_id, relevance_score)
    SELECT a.id, cj.category_id, a.relevance_score
    FROM articles a
    JOIN crawl_jobs cj ON a.crawl_job_id = cj.id
    WHERE cj.category_id IS NOT NULL
    ON CONFLICT DO NOTHING
    ```
  - [ ] Run migration: `docker-compose exec web alembic upgrade head`
  - [ ] Verify table created: `docker-compose exec postgres psql -U postgres -d google_news -c "\d article_categories"`

- [ ] **Phase 2: Fix sync_engine.py Keyword & Relevance Logic** (AC: 1, 2) - 1 hour
  - [ ] Open `src/core/crawler/sync_engine.py` and locate line 1454-1461 (save logic)
  - [ ] Import keyword matcher: `from src.core.crawler.keyword_matcher import enhance_articles_with_matched_keywords`
  - [ ] BEFORE calling `save_articles_with_deduplication()`, add:
    ```python
    # Step 3a: Enhance with keyword matching
    enhanced_articles = enhance_articles_with_matched_keywords(
        extracted_articles,
        category.keywords or []
    )

    # Step 3b: Add relevance scoring (Binary: 50% title + 50% content)
    scored_articles = []
    for article in enhanced_articles:
        keywords = category.keywords or []
        matched = article.get('keywords_matched', [])

        if not keywords or not matched:
            article['relevance_score'] = 0.0
            scored_articles.append(article)
            continue

        # Get title and content
        title = (article.get('title', '') or '').lower()
        content = (article.get('content', '') or '').lower()

        # Check if ANY keyword appears in title or content
        has_title_match = any(kw.lower() in title for kw in matched)
        has_content_match = any(kw.lower() in content for kw in matched)

        # Binary scoring: 50% if matched in title, 50% if matched in content
        title_score = 0.5 if has_title_match else 0.0
        content_score = 0.5 if has_content_match else 0.0

        relevance = title_score + content_score
        article['relevance_score'] = relevance
        scored_articles.append(article)

    # Step 3c: Save enhanced articles
    saved_count = article_repo.save_articles_with_deduplication(
        scored_articles, category.id, job_id  # Use scored_articles not extracted_articles
    )
    ```
  - [ ] Test: Run crawl job and verify articles have keywords_matched populated
  - [ ] Test: Verify relevance_score is calculated (not 1.0 for all)

- [ ] **Phase 3: Fix sync_article_repo.py Hardcoded Relevance** (AC: 2) - 30 minutes
  - [ ] Open `src/database/repositories/sync_article_repo.py`
  - [ ] Find line 91: `relevance_score=1.0,`
  - [ ] Replace with: `relevance_score=article_data.get('relevance_score', 1.0),`
  - [ ] Add debug logging to verify relevance score is read from article_data:
    ```python
    logger.debug(f"Creating article with relevance_score: {article_data.get('relevance_score', 1.0)}")
    ```
  - [ ] Test: Crawl category and check database for varying relevance scores

- [ ] **Phase 4: Multi-Category Auto-Linking** (AC: 4) - 2 hours
  - [ ] Create new file `src/core/linking/category_matcher.py`
  - [ ] Implement `CategoryMatcher` class with method:
    ```python
    def find_matching_categories(
        self,
        article_dict: Dict,
        all_categories: List[Category],
        min_relevance: float = 0.3
    ) -> List[Dict]:
        """Find all categories matching article content."""
        # 1. Combine title + content
        # 2. For each active category:
        #    - Check exclude_keywords (skip if any match)
        #    - Find matched keywords
        #    - Calculate relevance = len(matched)/len(keywords)
        #    - If relevance >= min_relevance, add to matches
        # 3. Return sorted by relevance (desc)
    ```
  - [ ] Update `src/database/repositories/sync_article_repo.py`:
    - [ ] In `save_articles_with_deduplication()`, after creating new article
    - [ ] Import: `from src.core.linking.category_matcher import CategoryMatcher`
    - [ ] Import: `from src.database.repositories.sync_category_repo import SyncCategoryRepository`
    - [ ] Get all active categories (exclude primary category)
    - [ ] Use CategoryMatcher to find matches
    - [ ] Create ArticleCategory associations for each match
  - [ ] Add to `SyncCategoryRepository`:
    ```python
    def get_all_active(self) -> List[Category]:
        """Get all active categories."""
        with self.get_session() as session:
            categories = session.execute(
                select(Category).where(Category.is_active == True)
            ).scalars().all()
            return list(categories)
    ```
  - [ ] Test: Crawl article matching multiple categories, verify article_categories has multiple entries

- [ ] **Phase 5: Frontend Updates** (AC: 5) - 1 hour
  - [ ] Update `frontend/src/types/shared.ts`:
    ```typescript
    export interface ArticleResponse {
      // ... existing fields ...
      categories?: Array<{
        id: string;
        name: string;
        relevance_score: number;
      }>;
      primary_category_id?: string;
    }
    ```
  - [ ] Update `frontend/src/components/features/jobs/JobArticlesModal.tsx` (around line 261):
    ```tsx
    {/* Display categories */}
    {article.categories && article.categories.length > 0 && (
      <div className="mb-2">
        <span className="text-xs text-gray-500">Categories: </span>
        <div className="inline-flex flex-wrap gap-1">
          {article.categories.map(cat => (
            <span
              key={cat.id}
              className={`px-2 py-1 text-xs rounded-full ${
                cat.id === article.primary_category_id
                  ? 'bg-blue-600 text-white'
                  : 'bg-blue-100 text-blue-800'
              }`}
              title={`Relevance: ${Math.round(cat.relevance_score * 100)}%`}
            >
              {cat.name}
            </span>
          ))}
        </div>
      </div>
    )}

    {/* Keep keywords display */}
    {article.keywords_matched && article.keywords_matched.length > 0 && (
      <div className="mb-2">
        <span className="text-xs text-gray-500">Matched keywords: </span>
        <div className="inline-flex flex-wrap gap-1">
          {article.keywords_matched.map(kw => (
            <span key={kw} className="px-2 py-1 text-xs bg-gray-100 rounded-full">
              {kw}
            </span>
          ))}
        </div>
      </div>
    )}
    ```
  - [ ] Update API endpoint `src/api/routes/articles.py` to include categories in response:
    ```python
    .options(selectinload(Article.categories))  # Load ArticleCategory relationships
    ```
  - [ ] Build frontend: `cd frontend && npm run build`
  - [ ] Test: View article in modal, verify categories and keywords display correctly

- [ ] **Testing & Validation**
  - [ ] Run full crawl for 1 category
  - [ ] Verify in database:
    - [ ] `SELECT keywords_matched FROM articles WHERE id = '<article_id>';` → NOT empty
    - [ ] `SELECT relevance_score FROM articles WHERE id = '<article_id>';` → NOT 1.0 for all
    - [ ] `SELECT COUNT(*) FROM article_categories WHERE article_id = '<article_id>';` → > 1 for multi-match
  - [ ] Verify in UI:
    - [ ] Open Jobs page → View Articles
    - [ ] Check article shows multiple category badges
    - [ ] Check keywords_matched displays
    - [ ] Check relevance % shown per category

## Dev Notes

### Source Tree Context

**Migration Location:**
- Create in: `src/database/migrations/versions/`
- Pattern: `011_create_article_categories_table.py`
- Run via: `docker-compose exec web alembic upgrade head`

**Crawler Logic:**
- Main sync engine: `src/core/crawler/sync_engine.py` (Line 1362-1461)
- Keyword matcher: `src/core/crawler/keyword_matcher.py` (enhance_articles_with_matched_keywords)
- Article repo: `src/database/repositories/sync_article_repo.py` (save_articles_with_deduplication)

**Models:**
- Article: `src/database/models/article.py` (has keywords_matched, relevance_score fields)
- Category: `src/database/models/category.py` (has keywords, exclude_keywords)
- ArticleCategory: `src/database/models/article_category.py` (junction table model - EXISTS but table missing!)

**Frontend:**
- Types: `frontend/src/types/shared.ts`
- Modal: `frontend/src/components/features/jobs/JobArticlesModal.tsx`
- API: `src/api/routes/articles.py`

### Technical Details from Architecture

**Database Schema (article_categories):**
```sql
CREATE TABLE article_categories (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    article_id UUID NOT NULL REFERENCES articles(id) ON DELETE CASCADE,
    category_id UUID NOT NULL REFERENCES categories(id) ON DELETE CASCADE,
    relevance_score DECIMAL(3,2) DEFAULT 1.0,
    created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
    CONSTRAINT uq_article_category UNIQUE (article_id, category_id),
    CONSTRAINT valid_relevance_score CHECK (relevance_score >= 0.0 AND relevance_score <= 1.0)
);
```

**Keyword Matching Logic:**
- Extract keywords from category.keywords list
- Search in `article.title + article.content` (case-insensitive)
- Store matched keywords in `article.keywords_matched` array

**Relevance Score Formula (Binary 50-50 Split):**
- Title score: 50% if ANY keyword found in title, else 0%
- Content score: 50% if ANY keyword found in content, else 0%
- Relevance = `title_score + content_score`
- Possible values: 0.0 (no match), 0.5 (title OR content), 1.0 (title AND content)
- Rationale: Matching in title and content are equally important; number of keywords matched doesn't affect score

**Multi-Category Linking:**
- Min relevance threshold: 0.3 (30% keywords must match)
- Exclude keywords have priority (if any match, skip category)
- Primary category (from crawl) always gets association
- Auto-link creates additional ArticleCategory records for matches

### Current Bug Analysis

**Database Evidence:**
```sql
-- All articles have empty keywords_matched
SELECT COUNT(*) FROM articles WHERE keywords_matched = '{}';  -- Result: 369/369

-- All articles have relevance_score = 1.0
SELECT COUNT(*) FROM articles WHERE relevance_score = 1.0;  -- Result: 369/369

-- Junction table doesn't exist
SELECT * FROM article_categories;  -- ERROR: relation does not exist
```

**Code Flow (Current - BUGGY):**
1. `sync_engine.py` line 1449: Extracts articles → `extracted_articles`
2. Line 1454-1461: **SKIPS** keyword matching & relevance scoring
3. Calls `save_articles_with_deduplication(extracted_articles, ...)`
4. `sync_article_repo.py` line 90-91: Uses `keywords_matched` from article_data (empty!) and hardcodes `relevance_score=1.0`

**Code Flow (Fixed):**
1. Extract articles
2. **Enhance with keywords** → `enhanced_articles` (keywords_matched populated)
3. **Calculate relevance** → `scored_articles` (relevance_score calculated)
4. Save `scored_articles` (has both fields)
5. **Auto-link** to other matching categories (create ArticleCategory records)

### Testing Standards

**Test File Locations:**
- Migration test: Manual verification via psql commands
- Backend logic: `tests/unit/crawler/test_keyword_matcher.py` (if exists)
- Integration: Manual crawl + database verification

**Testing Framework:**
- Backend: pytest (existing tests in tests/ directory)
- Frontend: React Testing Library (if adding new components)

**Test Cases:**
1. **Migration Test:**
   - Run migration up → verify table exists
   - Insert test data → verify constraints work
   - Run migration down → verify clean rollback

2. **Keyword Matching Test:**
   - Article with 3/5 keywords → keywords_matched=[kw1, kw2, kw3], relevance=0.6
   - Article with 0/5 keywords → keywords_matched=[], relevance=0.0
   - Article with exclude keyword → not linked to category

3. **Multi-Category Test:**
   - Article matching "Cryptocurrency" (2/5 keywords, relevance=0.4)
   - Also matches "Chứng khoán" (3/10 keywords, relevance=0.3)
   - Should create 2 ArticleCategory records with different relevance scores

4. **Frontend Test:**
   - Mock article with 2 categories → verify 2 badges shown
   - Primary category → blue badge, others → light blue
   - Hover badge → tooltip shows relevance %

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-03 | 1.0 | Initial urgent story creation based on production bug analysis | Bob (Scrum Master) |
| 2025-10-03 | 1.1 | Updated relevance scoring to binary 50-50 split (title/content). Status: Draft → Approved | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References
- Migration created and executed successfully: 011_create_article_categories_table.py
- Table verification: article_categories table created with proper indexes and constraints
- Data migration: 191 existing article-category associations migrated successfully
- Backend services restarted to apply code changes

### Completion Notes List
- All 5 phases completed successfully
- Database migration created article_categories junction table with proper indexes
- sync_engine.py now enhances articles with keyword matching and binary relevance scoring
- sync_article_repo.py reads relevance_score from article_data instead of hardcoding 1.0
- Multi-category auto-linking implemented with CategoryMatcher class
- Frontend updated to display multiple category badges and keywords
- Backend API updated to load and return categories with relevance scores

### File List
#### Created Files:
- src/database/migrations/versions/011_create_article_categories_table.py
- src/core/linking/__init__.py
- src/core/linking/category_matcher.py

#### Modified Files:
- src/core/crawler/sync_engine.py
- src/database/repositories/sync_article_repo.py
- src/database/repositories/article_repo.py
- src/api/routes/articles.py
- src/api/schemas/article.py
- frontend/src/services/articlesService.ts
- frontend/src/components/features/jobs/JobArticlesModal.tsx

## QA Results
_To be filled by QA agent_
